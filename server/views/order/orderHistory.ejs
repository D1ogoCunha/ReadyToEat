<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order History</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/stylesheets/menu/menus.css" />
    <link rel="stylesheet" href="/stylesheets/partials/navbar.css" />
  </head>
  <body>
    <%- include('../partials/navbar', { user: user }) %>
    <div class="container-xl px-4 mt-4">
      <hr class="mt-0 mb-4" />
      <h1 class="text-center">Order History</h1>

      <!-- Orders Table -->
      <div class="card-body p-0">
        <div class="table-responsive table-order-history">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>#</th>
                <% if (user.role === "restaurant") { %>
                  <th>Customer</th>
                  <th>NIF</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Dishes</th>
                <% } else if (user.role === "customer") { %>
                  <th>Restaurant</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Dishes</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% if (orders && orders.length > 0) { %> <% orders.forEach((order,
              index) => { %>
              <tr>
                <td><%= index + 1 %></td>

                <% if (user.role === "restaurant") { %>
                <td>
                  <% if (order.customerId && order.customerId.firstName) { %>
                  <%= order.customerId.firstName %> <%=
                  order.customerId.lastName %> <% } else { %> Unknown Customer
                  <% } %>
                </td>
                <td>
                  <% if (order.customerId && order.customerId.nif) { %> <%=
                  order.customerId.nif %> <% } else { %> Unknown NIF <% } %>
                </td>
                <td>$<%= order.amount ? order.amount.toFixed(2) : '0.00' %></td>
                <td>
                  <select class="form-select form-select-sm order-status-select"
                          data-order-id="<%= order._id %>">
                    <option value="Pending" <%= order.status === "Pending" ? "selected" : "" %>>Pending</option>
                    <option value="Completed" <%= order.status === "Completed" ? "selected" : "" %>>Completed</option>
                    <option value="Cancelled" <%= order.status === "Cancelled" ? "selected" : "" %>>Cancelled</option>
                  </select>
                </td>
                <td>
                <%= order.date ? new Date(order.date).toLocaleDateString() : 'N/A' %>
                </td>
                <td>
                  <% if (order.dishes && order.dishes.length > 0) { %>
                  <ul>
                    <% order.dishes.forEach(dish => { %>
                    <li>
                      <%= dish.nome || 'Unnamed dish' %> - $<%= dish.preco ?
                      dish.preco.toFixed(2) : '0.00' %>
                    </li>
                    <% }) %>
                  </ul>
                  <% } else { %> No dishes <% } %>
                </td>
                <% } else if (user.role === "customer") { %>
                <td>
                  <% if (order.restaurantId &&
                  order.restaurantId.restaurantName) { %> <%=
                  order.restaurantId.restaurantName %> <% } else { %> Unknown
                  Restaurant <% } %>
                </td>
                <td>$<%= order.amount ? order.amount.toFixed(2) : '0.00' %></td>
                <td>
                  <%= order.date ? new Date(order.date).toLocaleDateString() :
                  'N/A' %>
                </td>
                <td>
                  <% if (order.dishes && order.dishes.length > 0) { %>
                  <ul>
                    <% order.dishes.forEach(dish => { %>
                    <li>
                      <%= dish.nome || 'Unnamed dish' %> - $<%= dish.preco ?
                      dish.preco.toFixed(2) : '0.00' %>
                    </li>
                    <% }) %>
                  </ul>
                  <% } else { %> No dishes <% } %>
                </td>
                <% } %>
              </tr>
              <% }) %> <% } else { %>
              <tr>
                <td colspan="5" class="text-center">No orders found.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Create Phone Order Button (For Restaurants Only) -->
      <% if (user.role === "restaurant") { %>
      <div class="d-flex justify-content-end mb-3">
        <a href="/order/phone" class="btn btn-primary">Create Phone Order</a>
      </div>
      <% } %>
    </div>
  </body>
    <script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.order-status-select').forEach(function(select) {
      select.addEventListener('change', function() {
        const orderId = this.dataset.orderId;
        const newStatus = this.value;
        fetch('/order/update-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ orderId, status: newStatus })
        })
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
        })
        .catch(() => alert('Error updating order status'));
      });
    });
  });
  </script>
</html>
